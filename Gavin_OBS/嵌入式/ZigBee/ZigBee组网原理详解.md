# ZigBee组网原理详解

[www.eefocus.com](https://www.eefocus.com/e/499461.html)

组建一个完整的zigbee网状网络包括两个步骤：网络初始化、节点加入网络。其中节点加入网络又包括两个步骤：通过与协调器连接入网和通过已有父节点入网。关于“**zigbee组网原理详解 zigbee组网方法**”的详细说明。

## 目录

[TOC]

## 一.zigbee组网原理详解

组建一个完整的zigbee网状网络包括两个步骤：网络初始化、节点加入网络。

其中节点加入网络又包括两个步骤：通过与协调器连接入网和通过已有父节点入网.

### 1. 网络初始化预备

Zigbee网络的建立是由网络协调器发起的，任何一个zigbee节点要组建一个网络必须要满足以下两点要求：

1. 节点是FFD节点，具备zigbee协调器的能力；
2. 节点还没有与其他网络连接，当节点已经与其他网络连接时，此节点只能作为该网络的子节点，因为一个zigbee网络中有且只有一个网络协调器。

- FFD：Full FuncTIon Device 全功能节点
- RFD：Reduced FuncTIonDevice 半功能节点

### 2. 网络初始化流程

1. 确定网络协调器：

   - 首先判断节点是否是FFD节点，接着判断此FFD节点是否在其他网络里或者网络里是否已经存在协调器。通过主动扫描，发送一个信标请求命令（Beaconrequest command），然后设置一个扫描期限（T\_scan\_duraTIon），如果在扫描期限内都没有检测到信标，那么就认为FFD在其pos内没有协调器，那么此时就可以建立自己的zigbee网络，并且作为这个网络的协调器不断地产生信标并广播出去。

     注意：一个网络里，有且只能有一个协调器（coordinator）。

2. 进行信道扫描过程:

   - 包括能量扫描和主动扫描两个过程：首先对指定的信道或者默认的信道进行能量检测，以避免可能的干扰。以递增的方式对所测量的能量值进行信道排序，抛弃那么些能量值超出了可允许能量水平的信道，选择可允许能量水平的信道并标注这些信道是可用信道。接着进行主动扫描，搜索节点通信半径内的网络信息。这些信息以信标帧的形式在网络中广播，节点通过主动信道扫描方式获得这些信标帧，然后根据这些信息，找到一个最好的、相对安静的信道，通过记录的结果，选择一个信道，该信道应存在最少的zigbee网络，最好是没有zigbee设备。在主动扫描期间，MAC层将丢弃PHY层数据服务接收到的除信标以外的所有帧。

3. 设置网络ID:

   - 找到合适的信道后，协调器将为网络选定一个网络标识符（PAN ID，取值《=0x3FFF），这个ID在所使用的信道中必须是唯一的，也不能和其他zigbee网络冲突，而且不能为广播地址0xFFFF（此地址为保留地址，不能使用）。PAN ID可以通过侦听其他网络的ID然后选择一个不会冲突的ID的方式来获取，也可以人为的指定扫描的信道后，来确定不和其他网络冲突的PAN ID。
   - 在zigbee网络中有两种地址模式：扩展地址（64位）和短地址（16位），其中扩展地址由IEEE组织分配，用于唯一的设备标识；短地址用于本地网络中设备标识，在一个网络中，每个设备的短地址必须唯一，当节点加入网络时由其父节点分配并通过使用短地址来通信。对于协调器来说，短地址通常设定为0x0000。
   - 上面步骤完成后，就成功初始化了zigbee网状网络，之后就等待其他节点的加入。节点入网时将选择范围内信号最强的父节点（包括协调器）加入网络，成功后将得到一个网络短地址并通过这个地址进行数据的发送和接收，[网络拓扑](https://www.eefocus.com/baike/514491.html)关系和地址就会保存在各自的flash中。

### 3. 节点通过协调器加入网络

当节点协调器确定之后，节点首先需要和协调器建立连接加入网络。

为了建立连接，FFD节点需要向协调器提出请求，协调器接收到节点的连接请求后根据情况决定是否允许其连接，然后对请求连接的节点做出响应，节点与协调器建立连接后，才能实现数据的收发。节点加入网络的具体流程可以分为下面的步骤：

1. 查找网络协调器:
2. 发送关联请求命令（Associaterequest command）
3. 等待协调器处理
4. 发送数据请求命令
5. 回复



#### 3.1 查找网络协调器

首先会主动扫描查找周围网络的协调器，如果在扫描期限内检测到信 标，那么将获得了协调器的有关信息，这时就向协调器发出连接请求。在选择合适的网络之后，上层将请求MAC层对物理层PHY和MAC层的phyCurrentChannel、macPANID等PIB属性进行相应的设置。如果没有检测到，间隔一段时间后，节点重新发起扫描。

#### 3.2 发送关联请求命令（Associaterequest command）

节点将关联请求命令发送给协调器，协调器收到后立即回复一个确认帧（ACK），同时向它的上层发送连接指示原语，表示已经收到节点的连接请求。但是这并不意味着已经建立连接，只表示协调器已经收到节点的连接请求。当协调器的mac层的上层接收到连接指示原语后，将根据自己的资源情况（存储空间和能量）决定是否同意此节点的加入请求，然后给节点的mac层发送响应。

#### 3.3 等待协调器处理

当节点收到协调器加入关联请求命令的ACK后，节点mac将等待一段时间，接受协调器的连接响应。在预定的时间内，如果接收到连接响应，它将这个响应向它的上层通告。而协调器给节点的mac层发送响应时会设置一个等待响应时间（T_ResponseWaitTIme）来等待协调器对其加入请求命令的处理，若协调器的资源足够，协调器会给节点分配一个16位的短地址，并产生包含新地址和连接成功状态的连接响应命令，则此节点将成功的和协调器建立连接并可以开始通信。若协调器资源不够，待加入的节点将重新发送请求信息，直接入网成功。

#### 3.4 发送数据请求命令

如果协调器在响应时间内同意节点加入，那么将产生关联响应命令（Associateresponse command）并存储这个命令。当响应时间过后，节点发送数据请求命令（Datarequest command）给协调器，协调器收到后立即回复ACK，然后将存储的关联响应命令发给节点。如果在响应时间到后，协调器还没有决定是否同意节点加入，那么节点将试图从协调器的信标帧中提取关联响应命令，成功的话就可以入网成功，否则重新发送请求信息直到入网成功。

#### 3.5 回复

节点收到关联响应命令后，立即向协调器回复一个确认帧（ACK），以确认接收到连接响应命令，此时节点将保存协调器的短地址和扩展地址，并且节点的MLME向上层发送连接确认原语，通告关联加入成功的信息。

### 4. 节点通过已有节点加入网络

当靠近协调器的FFD节点和协调器关联成功后，处于这个网络范围内的其他节点就以这些FFD节点作为父节点加入网络了，具体加入网络有两种方式，一种是通过关联（associate）方式，就是待加入的节点发起加入网络；另一种是直接（direct）方式，就是待加入的节点具体加入到那个节点下，作为该节点的子节点。其中关联方式是zigbee网络中新节点加入网络的主要途径。

对于一个节点来说只有没有加入过网络的才能进行加入网络。在这些节点中，有些是曾经加入过网络中，但是却与它的父节点失去联系（这样的被称为孤儿节点），而有些则是新节点。当是孤儿节点时，在它的相邻表中存有原父节点的信息，于是它可以直接给原父节点发送加入网络的请求信息。如果父节点有能力同意它加入，于是直接告诉它的以前被分配的网络地址，它便入网成功；如果此时它原来的父节点的网络中，子节点数已达到最大值，也就是说网络地址已经分配满，父节点便无法批准它加入，它只能以新节点身份重新寻找并加入网络。

而对于新节点来说，他首先会在预先设定的一个或多个信道上通过主动或被动扫描周围它可以找到的网络，寻找有能力批准自己加入网络的父节点，并把可以找到的父节点的资料存入自己的相邻表。存入相邻表的父节点的资料包括zigbee协议的版本、协议栈的规范、PAN ID和可以加入的信息。在相邻表中所有的父节点中选择一个深度最小的，并对其发出请求信息，如果出现相同最小深度的两个以上的父节点，那么随机选取一个发送请求。如果相邻表中没有合适的父节点的信息，那么表示入网失败，终止过程。如果发出的请求被批准，那么父节点同时会分配一个16位的网络地址，此时入网成功，子节点可以开始通信。如果请求失败，那么重新查找相邻表，继续发送请求信息，直到加入网络。



## 二.zigbee组网方法

ZigBee协议栈的物理层及MAC层都是IEEE802.5.14标准中定义的。PHY层(物理层)规定了所使用的频段，以及所使用的编码、调制、扩频、调频等无线传输技术。

MAC层的主要作用规定了无线信道的访问控制机制，也就是规定各个设备按照什么规矩轮流使用信道；如果没有MAC层协议，节点一多，没有规矩的收发机制，就会发生信号冲突，则无法正常传输数据了。

ZigBee协议栈在802.15.4协议基础上定义了网络层。网络层的主要作用是负责设备的连接和断开、在帧数据传递时采用的安全机制、路由发现和维护。简单说，就是保障设备之间的组网和网络节点间的数据传输。

标准的ZigBee网络协议包括协调器、路由器和终端节点，而建立一个ZigBee网络除了必须要有的协调器之外，仅需加上路由器或终端节点即可。

在启动标准ZigBee Pro网络通讯前，如果没有建立存储跳转路径的路由表，则节点无法通信，同样需要定时地发送网络报文检查节点是否异常。由此可见，ZigBee Pro不仅启动速度慢，而且定时发送网络报文占用大量的带宽。



[查看原网页: www.eefocus.com](https://www.eefocus.com/e/499461.html)